{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="result-section">
            <h2>Video Processing Results</h2>
            <div class="alert alert-success">
                <h4>Summary</h4>
                <p>Total frames processed: {{ results.processed_frames }} / {{ results.total_frames }}</p>
                <p>Total license plates detected: {{ results.total_plates }}</p>
            </div>

            {% if results.violations and results.violations|length > 0 %}
            <div class="alert alert-warning">
                <h4>Violations</h4>
                <p>Total violations detected: {{ results.violations|length }}</p>
                <p>Types: {% for v in results.violations|map(attribute='type')|unique %}{{ v }}{% if not loop.last %}, {% endif %}{% endfor %}</p>
            </div>
            {% endif %}

            {% if results.violations and results.violations|length > 0 %}
            <div class="mt-4">
                <h4>Sample Violations</h4>
                <div class="row">
                    {% for v in results.violations[:10] %}
                    <div class="col-md-3">
                        <div class="card mb-2">
                            {% if v.thumb %}
                            <img src="{{ url_for('static', filename='output/' + v.thumb) }}" class="card-img-top" alt="violation thumb">
                            {% endif %}
                            <div class="card-body">
                                <h6 class="card-title">{{ v.type.replace('_', ' ')|title }}</h6>
                                <p class="card-text"><small>Frame: {{ v.frame_number if v.frame_number is defined else v.get('frame', 'N/A') }}</small></p>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if results.visualization %}
            <div class="mt-4">
                <h4>Detection Statistics</h4>
                <div class="text-center">
                    <img src="{{ url_for('static', filename='output/' + results.visualization) }}" 
                        alt="Detection Statistics" class="img-fluid rounded shadow">
                </div>
            </div>
            {% endif %}

            {% if results.violation_visualization %}
            <div class="mt-4">
                <h4>Violations Overview</h4>
                <div class="text-center">
                    <img src="{{ url_for('static', filename='output/' + results.violation_visualization) }}" 
                        alt="Violation Comparison" class="img-fluid rounded shadow" style="max-width:480px;">
                </div>
                <div class="mt-2 text-center">
                    <a href="{{ url_for('download_file', filename=results.violation_visualization) }}" class="btn btn-sm btn-info">Download Violation Visualization</a>
                </div>
            </div>
            {% endif %}

            <div class="mt-4">
                <h4>Download Results</h4>
                <a href="{{ url_for('download_file', filename=excel_file) }}" class="btn btn-success">Download Excel Report</a>
                <a href="{{ url_for('download_file', filename=output_video) }}" class="btn btn-primary">Download Processed Video</a>
                {% if results.visualization %}
                    <a href="{{ url_for('download_file', filename=results.visualization) }}" class="btn btn-info">Download Visualization</a>
                {% endif %}
            </div>
        </div>
        
        {% if results.plates %}
        <div class="result-section">
            <h3>Sample Detected License Plates</h3>
            <div class="alert alert-info">Showing up to 10 detected plates. Download the Excel report for the complete list.</div>
            <div class="row">
                {% for plate in results.plates %}
                <div class="col-md-6">
                    <div class="card plate-card plate-{{ plate['Plate Type']|lower|replace(' ', '-') }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ plate['License Plate'] }}</h5>
                            <p class="card-text">
                                <strong>Frame:</strong> {{ plate['Frame'] }}<br>
                                <strong>Vehicle Type:</strong> {{ plate['Vehicle Type'] }}<br>
                                <strong>Vehicle ID:</strong> {{ plate['Vehicle ID'] }}<br>
                                <strong>Plate Type:</strong> {{ plate['Plate Type'] }}<br>
                                <strong>Confidence:</strong> {{ "%.2f"|format(plate['Confidence'] * 100) }}%
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <div class="d-grid gap-2">
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary btn-lg">Process Another File</a>
        </div>
    </div>
</div>
{% endblock %}